# Kessel-in-a-Box: Phase 4 - Observability
# Adds comprehensive monitoring with Prometheus, Grafana, and Jaeger

services:
  # Prometheus - Metrics collection and storage
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: kessel-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=${PROMETHEUS_RETENTION:-15d}'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
    ports:
      - "${PROMETHEUS_PORT:-9091}:9090"
    volumes:
      - ../prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ../prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus-data:/prometheus
    depends_on:
      - spicedb
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - kessel-network
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'

  # Grafana - Visualization and dashboards
  grafana:
    image: grafana/grafana:10.2.2
    container_name: kessel-grafana
    environment:
      # Admin credentials
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}

      # Server settings
      GF_SERVER_ROOT_URL: http://localhost:${GRAFANA_PORT:-3000}
      GF_SERVER_DOMAIN: localhost

      # Anonymous access (for development)
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: Viewer

      # Database (default SQLite for simplicity)
      GF_DATABASE_TYPE: sqlite3

      # Plugins
      GF_INSTALL_PLUGINS: grafana-piechart-panel,grafana-clock-panel

      # Disable telemetry
      GF_ANALYTICS_REPORTING_ENABLED: "false"
      GF_ANALYTICS_CHECK_FOR_UPDATES: "false"
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ../grafana/provisioning:/etc/grafana/provisioning:ro
      - ../grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      prometheus:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - kessel-network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.25'

  # Jaeger - Distributed tracing (REMOVED - not configured, saves 512MB RAM)
  # jaeger:
  #   image: jaegertracing/all-in-one:1.52
  #   container_name: kessel-jaeger
  #   environment:
  #     # Collector settings
  #     COLLECTOR_OTLP_ENABLED: "true"
  #     COLLECTOR_ZIPKIN_HOST_PORT: ":9411"
  #
  #     # Storage
  #     SPAN_STORAGE_TYPE: badger
  #     BADGER_EPHEMERAL: "false"
  #     BADGER_DIRECTORY_VALUE: /badger/data
  #     BADGER_DIRECTORY_KEY: /badger/key
  #
  #     # Query settings
  #     QUERY_BASE_PATH: /
  #
  #     # Sampling
  #     SAMPLING_STRATEGIES_FILE: /etc/jaeger/sampling.json
  #   ports:
  #     # Jaeger UI
  #     - "${JAEGER_UI_PORT:-16686}:16686"
  #     # Collector HTTP
  #     - "${JAEGER_COLLECTOR_HTTP_PORT:-14268}:14268"
  #     # Collector gRPC
  #     - "${JAEGER_COLLECTOR_GRPC_PORT:-14250}:14250"
  #     # OTLP gRPC
  #     - "${JAEGER_OTLP_GRPC_PORT:-4317}:4317"
  #     # OTLP HTTP
  #     - "${JAEGER_OTLP_HTTP_PORT:-4318}:4318"
  #     # Zipkin
  #     - "9411:9411"
  #   volumes:
  #     - jaeger-data:/badger
  #     - ../jaeger/sampling.json:/etc/jaeger/sampling.json:ro
  #   healthcheck:
  #     test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:16686/"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   networks:
  #     - kessel-network
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 512M
  #         cpus: '0.5'
  #       reservations:
  #         memory: 128M
  #         cpus: '0.25'

  # AlertManager - Alert routing and management (optional)
  alertmanager:
    image: prom/alertmanager:v0.26.0
    container_name: kessel-alertmanager
    command:
      - '--config.file=/etc/alertmanager/config.yml'
      - '--storage.path=/alertmanager'
      - '--web.external-url=http://localhost:${ALERTMANAGER_PORT:-9093}'
    ports:
      - "${ALERTMANAGER_PORT:-9093}:9093"
    volumes:
      - ../alertmanager/config.yml:/etc/alertmanager/config.yml:ro
      - alertmanager-data:/alertmanager
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9093/-/healthy"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - kessel-network
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'

  # Node Exporter - Host metrics (optional)
  node-exporter:
    image: prom/node-exporter:v1.7.0
    container_name: kessel-node-exporter
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--path.rootfs=/host'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    ports:
      - "${NODE_EXPORTER_PORT:-9100}:9100"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/host:ro
    networks:
      - kessel-network
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.25'

  # Health Check Exporter - Converts health endpoints to Prometheus metrics
  health-exporter:
    build:
      context: ../health-exporter
      dockerfile: Dockerfile
    image: kessel-health-exporter:latest
    container_name: kessel-health-exporter
    ports:
      - "${HEALTH_EXPORTER_PORT:-9094}:9091"
    depends_on:
      - prometheus
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:9091/health', timeout=2)"]
      interval: 30s
      timeout: 5s
      retries: 3
    networks:
      - kessel-network
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.25'
        reservations:
          memory: 64M
          cpus: '0.1'

volumes:
  prometheus-data:
    driver: local
    name: kessel-prometheus-data
  grafana-data:
    driver: local
    name: kessel-grafana-data
  # jaeger-data:
  #   driver: local
  #   name: kessel-jaeger-data
  alertmanager-data:
    driver: local
    name: kessel-alertmanager-data

networks:
  kessel-network:
    external: true
