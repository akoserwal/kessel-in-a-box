# Kessel-in-a-Box: Kessel Services
# Uses the REAL project-kessel/relations-api and project-kessel/inventory-api
# Images from quay.io/cloudservices/kessel-relations and kessel-inventory

services:
  # Kessel Relations API - Authorization service (talks to SpiceDB)
  # Source: https://github.com/project-kessel/relations-api
  # CRITICAL: This is the ONLY service that talks to SpiceDB directly
  kessel-relations-api:
    image: quay.io/cloudservices/kessel-relations:${KESSEL_RELATIONS_TAG:-latest}
    container_name: kessel-relations-api
    command: ["-conf", "/configs"]
    ports:
      - "${KESSEL_RELATIONS_PORT:-8082}:8000"  # HTTP (path prefix: /api/authz)
      - "${KESSEL_RELATIONS_GRPC_PORT:-9001}:9000"  # gRPC
    environment:
      SPICEDB_PRESHARED: ${SPICEDB_PRESHARED_KEY:-testtesttesttest}
      SPICEDB_ENDPOINT: spicedb:50051
      SPICEDB_SCHEMA_FILE: /schema/schema.zed
    volumes:
      - ../services/kessel-relations-api/configs:/configs:ro
      - ../services/spicedb/schema:/schema:ro
    depends_on:
      spicedb:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -sf -X POST -H 'Content-Type: application/json' -d '{\"tuples\":[]}' http://localhost:8000/api/authz/v1beta1/tuples || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - kessel-network
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'

  # Kessel Inventory API - Database migration (runs once before serve)
  kessel-inventory-migrate:
    image: quay.io/cloudservices/kessel-inventory:${KESSEL_INVENTORY_TAG:-latest}
    container_name: kessel-inventory-migrate
    command: ["migrate", "--config", "/config/.inventory-api.yaml"]
    volumes:
      - ../services/kessel-inventory-api/.inventory-api.yaml:/config/.inventory-api.yaml:ro
    depends_on:
      postgres-inventory:
        condition: service_healthy
    networks:
      - kessel-network
    restart: "no"

  # Kessel Inventory API - Resource management + Authorization proxy
  # Source: https://github.com/project-kessel/inventory-api
  # CRITICAL: Depends on relations-api for all authorization calls (via gRPC)!
  kessel-inventory-api:
    image: quay.io/cloudservices/kessel-inventory:${KESSEL_INVENTORY_TAG:-latest}
    container_name: kessel-inventory-api
    command: ["serve", "--config", "/config/.inventory-api.yaml"]
    ports:
      - "${KESSEL_INVENTORY_PORT:-8083}:8000"  # HTTP
      - "${KESSEL_INVENTORY_GRPC_PORT:-9002}:9000"  # gRPC
    volumes:
      - ../services/kessel-inventory-api/.inventory-api.yaml:/config/.inventory-api.yaml:ro
    depends_on:
      kessel-relations-api:
        condition: service_healthy
      kessel-inventory-migrate:
        condition: service_completed_successfully
      postgres-inventory:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8000/api/kessel/v1/livez"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - kessel-network
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'

networks:
  kessel-network:
    external: true
    name: kessel-network
